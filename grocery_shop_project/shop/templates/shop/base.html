<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-100 min-h-full">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-full flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h1>
                <p class="text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="phoneNumber" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="08xxxxxxxx" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                </div>
                
                <button type="submit" id="loginBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                
                <button type="button" id="registerBtn"
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
            </form>
            
            <div id="loginMessage" class="mt-4 text-center text-sm"></div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="hidden min-h-full flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h1>
                <p class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
            </div>
            
            <form id="registerForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="fullName" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="regPhoneNumber" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="08xxxxxxxx" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="regPassword" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" required>
                </div>
                
                <button type="submit" id="submitRegisterBtn"
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
                
                <button type="button" id="backToLoginBtn"
                        class="w-full bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>
            
            <div id="registerMessage" class="mt-4 text-center text-sm"></div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üì± QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <p class="text-gray-600">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
            </div>
            
            <div class="text-center mb-6">
                <!-- QR Code placeholder -->
                <div class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4">
                    <div class="text-6xl mb-2">üì±</div>
                    <div class="text-lg font-bold text-gray-800" id="qrAmount">0 ‡∏ö‡∏≤‡∏ó</div>
                    <div class="text-sm text-gray-600 mb-4">QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Pay</div>
                    
                    <!-- Simulated QR Code -->
                    <div class="bg-white border rounded-lg p-4 mb-4 inline-block">
                        <div class="w-32 h-32 bg-black relative">
                            <!-- QR Code pattern simulation -->
                            <div class="absolute inset-2 bg-white"></div>
                            <div class="absolute top-2 left-2 w-6 h-6 bg-black"></div>
                            <div class="absolute top-2 right-2 w-6 h-6 bg-black"></div>
                            <div class="absolute bottom-2 left-2 w-6 h-6 bg-black"></div>
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-black"></div>
                            <!-- Random pattern dots -->
                            <div class="absolute top-4 left-8 w-1 h-1 bg-black"></div>
                            <div class="absolute top-6 left-12 w-1 h-1 bg-black"></div>
                            <div class="absolute top-8 left-6 w-1 h-1 bg-black"></div>
                            <div class="absolute top-10 left-14 w-1 h-1 bg-black"></div>
                            <div class="absolute top-12 left-10 w-1 h-1 bg-black"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white border rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-2">Google Pay / PromptPay</div>
                        <div class="font-mono text-sm">0970528823</div>
                    </div>
                </div>
                <p class="text-sm text-gray-600">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏ß‡∏¢ Google Pay ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
                <p class="text-xs text-gray-500 mt-2">‡∏´‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß"</p>
            </div>
            
            <div class="flex space-x-3">
                <button id="confirmQrPaymentBtn" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium">
                    ‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                </button>
                <button id="cancelQrPaymentBtn" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md max-h-full overflow-y-auto">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h2>
                <div class="text-sm text-gray-600">‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</div>
            </div>
            
            <div id="receiptContent" class="space-y-4">
                <!-- Receipt content will be populated here -->
            </div>
            
            <div class="flex space-x-3 pt-6 border-t">
                <button id="closeReceiptBtn" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition duration-200 font-medium">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
            </div>
            
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°</label>
                    <input type="password" id="oldPassword" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="newPassword" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="confirmPassword" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" required>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                    </button>
                    <button type="button" id="cancelChangePasswordBtn" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </form>
            
            <div id="changePasswordMessage" class="mt-4 text-center text-sm"></div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="mainApp" class="hidden min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold text-gray-900">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-sm text-gray-600"></span>
                        <button id="changePasswordBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                        </button>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button class="tab-btn active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="products">
                        <span id="productsTabText">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="sales">
                        <span id="salesTabText">üí∞ ‡∏Ç‡∏≤‡∏¢</span>
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="purchase">
                        üõçÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="reports">
                        üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </nav>
            </div>
        </div>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Products Tab -->
            <div id="productsTab" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="productsTabTitle" class="text-2xl font-bold text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <button id="addProductBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>

                <!-- Category Filter -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button class="category-filter active bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200" data-category="all">
                            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button class="category-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200" data-category="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">
                            ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°
                        </button>
                        <button class="category-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200" data-category="‡∏Ç‡∏ô‡∏°">
                            üç™ ‡∏Ç‡∏ô‡∏°
                        </button>
                        <button class="category-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200" data-category="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á">
                            üçú ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á
                        </button>
                        <button class="category-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200" data-category="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á">
                            üßÇ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á
                        </button>
                        <button class="category-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200" data-category="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">
                            üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                        </button>
                    </div>
                </div>

                <!-- Add Product Form -->
                <div id="addProductForm" class="hidden bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                    <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="productPrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</label>
                            <input type="number" id="productStock" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="productCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                                <option value="‡∏Ç‡∏ô‡∏°">üç™ ‡∏Ç‡∏ô‡∏°</option>
                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á">üçú ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á</option>
                                <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á">üßÇ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</option>
                                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200 mr-2">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </button>
                            <button type="button" id="cancelProductBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Products List by Category -->
                <div id="productsContainer">
                    <!-- Products will be loaded here by category -->
                </div>
            </div>

            <!-- Sales Tab -->
            <div id="salesTab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="salesTabTitle" class="text-2xl font-bold text-gray-900">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                </div>

                <div id="salesContent">
                    <!-- This will be populated based on user role -->
                </div>
            </div>

            <!-- Purchase History Tab -->
            <div id="purchaseTab" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    </div>
                    <div id="purchaseHistory" class="divide-y divide-gray-200">
                        <!-- Purchase history will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content hidden">
                <h2 id="reportsTabTitle" class="text-2xl font-bold text-gray-900 mb-6">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <span class="text-2xl">üí∞</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p id="todaySales" class="text-2xl font-semibold text-gray-900">0 ‡∏ä‡∏¥‡πâ‡∏ô</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <span class="text-2xl">üì¶</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                                <p id="totalProducts" class="text-2xl font-semibold text-gray-900">0 ‡∏ä‡∏¥‡πâ‡∏ô</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <span class="text-2xl">üõí</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                                <p id="todayOrders" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAJZkcTaQYobb5lTAgcQCSqaRdVz0Sv-YU",
            authDomain: "store-7807c.firebaseapp.com",
            databaseURL: "https://store-7807c-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "store-7807c",
            storageBucket: "store-7807c.firebasestorage.app",
            messagingSenderId: "918177887447",
            appId: "1:918177887447:web:bf4d07392a07551460ac92"
        };

        // Initialize Firebase
        let app, database;
        let isFirebaseReady = false;

        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
        }

        // Global variables
        let currentUser = null;
        let products = {};
        let cart = [];
        let sales = {};
        let currentCategoryFilter = 'all';

        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const registerBtn = document.getElementById('registerBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');
        const changePasswordMessage = document.getElementById('changePasswordMessage');
        const userInfo = document.getElementById('userInfo');
        const loginMessage = document.getElementById('loginMessage');
        const registerMessage = document.getElementById('registerMessage');
        const loginBtn = document.getElementById('loginBtn');

        // Initialize Firebase ready state
        if (database) {
            isFirebaseReady = true;
            console.log('‚úÖ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        } else {
            isFirebaseReady = false;
            console.error('‚ùå Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        }

        // Tab functionality
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update active tab
                tabBtns.forEach(b => {
                    b.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                btn.classList.add('active', 'border-blue-500', 'text-blue-600');
                btn.classList.remove('border-transparent', 'text-gray-500');
                
                // Show/hide content
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(tabName + 'Tab').classList.remove('hidden');
                
                // Load tab-specific data
                if (tabName === 'reports') {
                    loadReports();
                } else if (tabName === 'purchase') {
                    loadPurchaseHistory();
                }
            });
        });

        // Authentication functions
        function showMessage(message, type = 'info') {
            const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            loginMessage.innerHTML = `<div class="${colorClass} bg-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}-50 p-3 rounded-lg border">${message}</div>`;
            setTimeout(() => {
                loginMessage.innerHTML = '';
            }, 5000);
        }

        async function login(phone, password) {
            if (!isFirebaseReady) {
                showMessage('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'error');
                return false;
            }

            try {
                showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
                
                const userRef = ref(database, `users/${phone}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === password) {
                        currentUser = { phone, ...userData };
                        showMessage('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        setTimeout(() => showMainApp(), 1000);
                        return true;
                    } else {
                        showMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                        return false;
                    }
                } else {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message, 'error');
                return false;
            }
        }

        async function register(name, phone, password) {
            if (!isFirebaseReady) {
                showRegisterMessage('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'error');
                return false;
            }

            try {
                showRegisterMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...', 'info');
                
                const userRef = ref(database, `users/${phone}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    showRegisterMessage('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                    return false;
                } else {
                    const userData = {
                        name: name,
                        password: password,
                        createdAt: new Date().toISOString(),
                        role: 'user'
                    };
                    
                    await set(userRef, userData);
                    showRegisterMessage('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'success');
                    setTimeout(() => {
                        showLoginScreen();
                        showMessage('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'success');
                    }, 2000);
                    return true;
                }
            } catch (error) {
                console.error('Register error:', error);
                showRegisterMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + error.message, 'error');
                return false;
            }
        }

        function showRegisterMessage(message, type = 'info') {
            const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            registerMessage.innerHTML = `<div class="${colorClass} bg-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}-50 p-3 rounded-lg border">${message}</div>`;
            setTimeout(() => {
                registerMessage.innerHTML = '';
            }, 5000);
        }

        function showRegisterScreen() {
            loginScreen.classList.add('hidden');
            registerScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        function showLoginScreen() {
            registerScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            // Clear register form
            document.getElementById('fullName').value = '';
            document.getElementById('regPhoneNumber').value = '';
            document.getElementById('regPassword').value = '';
            registerMessage.innerHTML = '';
        }

        function showMainApp() {
            loginScreen.classList.add('hidden');
            registerScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            // Check if user is admin
            if (currentUser.phone === '0970528823') {
                currentUser.role = 'admin';
                userInfo.textContent = `üëë ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${currentUser.name || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö'}`;
                // Admin sees different tab names
                document.getElementById('productsTabText').textContent = 'üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                document.getElementById('productsTabTitle').textContent = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                document.getElementById('salesTabText').textContent = 'üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢';
                document.getElementById('salesTabTitle').textContent = '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢';
                // Hide purchase tab for admin
                document.querySelector('[data-tab="purchase"]').style.display = 'none';
            } else {
                userInfo.textContent = `üë§ ${currentUser.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}`;
                // Regular users see different tab names
                document.getElementById('productsTabText').textContent = 'üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                document.getElementById('productsTabTitle').textContent = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                document.getElementById('salesTabText').textContent = 'üõí ‡∏ã‡∏∑‡πâ‡∏≠';
                document.getElementById('salesTabTitle').textContent = '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                // Show purchase tab for regular users
                document.querySelector('[data-tab="purchase"]').style.display = 'block';
            }
            
            // Load initial data
            loadProducts();
            loadSaleProducts();
            setupRealtimeListeners();
        }

        function showChangePasswordModal() {
            changePasswordModal.classList.remove('hidden');
            changePasswordForm.reset();
            changePasswordMessage.innerHTML = '';
        }

        function hideChangePasswordModal() {
            changePasswordModal.classList.add('hidden');
            changePasswordForm.reset();
            changePasswordMessage.innerHTML = '';
        }

        function showChangePasswordMessage(message, type = 'info') {
            const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            changePasswordMessage.innerHTML = `<div class="${colorClass} bg-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}-50 p-3 rounded-lg border">${message}</div>`;
            setTimeout(() => {
                changePasswordMessage.innerHTML = '';
            }, 5000);
        }

        async function changePassword(oldPassword, newPassword) {
            if (!isFirebaseReady) {
                showChangePasswordMessage('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'error');
                return false;
            }

            try {
                // Verify old password
                if (currentUser.password !== oldPassword) {
                    showChangePasswordMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return false;
                }

                // Update password in database
                const userRef = ref(database, `users/${currentUser.phone}`);
                await update(userRef, {
                    password: newPassword,
                    updatedAt: new Date().toISOString()
                });

                // Update current user object
                currentUser.password = newPassword;

                showChangePasswordMessage('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                setTimeout(() => {
                    hideChangePasswordModal();
                    showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }, 2000);
                return true;
            } catch (error) {
                console.error('Change password error:', error);
                showChangePasswordMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ' + error.message, 'error');
                return false;
            }
        }

        function logout() {
            currentUser = null;
            cart = [];
            products = {};
            sales = {};
            
            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            // Reset forms
            document.getElementById('phoneNumber').value = '';
            document.getElementById('password').value = '';
            loginMessage.innerHTML = '';
        }

        // Demo account function
        function useDemoAccount() {
            document.getElementById('phoneNumber').value = '0812345678';
            document.getElementById('password').value = '123456';
            showMessage('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà', 'info');
        }

        // Event listeners for authentication
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('phoneNumber').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (phone && password) {
                await login(phone, password);
            } else {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
            }
        });

        registerBtn.addEventListener('click', () => {
            showRegisterScreen();
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('regPhoneNumber').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            if (name && phone && password) {
                if (phone.length < 10) {
                    showRegisterMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å', 'error');
                    return;
                }
                if (password.length < 4) {
                    showRegisterMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                    return;
                }
                await register(name, phone, password);
            } else {
                showRegisterMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
            }
        });

        backToLoginBtn.addEventListener('click', () => {
            showLoginScreen();
        });

        changePasswordBtn.addEventListener('click', () => {
            showChangePasswordModal();
        });

        cancelChangePasswordBtn.addEventListener('click', () => {
            hideChangePasswordModal();
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            if (newPassword.length < 4) {
                showChangePasswordMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showChangePasswordMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', 'error');
                return;
            }
            
            await changePassword(oldPassword, newPassword);
        });

        logoutBtn.addEventListener('click', logout);

        // Product management
        const addProductBtn = document.getElementById('addProductBtn');
        const addProductForm = document.getElementById('addProductForm');
        const productForm = document.getElementById('productForm');
        const cancelProductBtn = document.getElementById('cancelProductBtn');

        addProductBtn.addEventListener('click', () => {
            if (currentUser.role === 'admin') {
                // Reset to add mode when clicking add product button
                resetProductForm();
                addProductForm.classList.remove('hidden');
                addProductForm.classList.add('fade-in');
            } else {
                showMessage('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
            }
        });

        // Function to reset product form to add mode
        function resetProductForm() {
            isEditingProduct = false;
            editingProductId = null;
            
            // Reset button text and style
            const submitButton = productForm.querySelector('button[type="submit"]');
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            submitButton.className = 'bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200 mr-2';
            
            // Reset form title
            const formTitle = document.querySelector('#addProductForm h3');
            formTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        }

        cancelProductBtn.addEventListener('click', () => {
            addProductForm.classList.add('hidden');
            productForm.reset();
            resetProductForm();
        });

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category: document.getElementById('productCategory').value || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                updatedAt: new Date().toISOString()
            };

            try {
                if (isEditingProduct && editingProductId) {
                    // Update existing product
                    const productRef = ref(database, `stores/0970528823/products/${editingProductId}`);
                    
                    // Keep original creation date if it exists
                    const existingProduct = products[editingProductId];
                    if (existingProduct && existingProduct.createdAt) {
                        productData.createdAt = existingProduct.createdAt;
                    }
                    
                    await update(productRef, productData);
                    showMessage('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    // Add new product
                    productData.createdAt = new Date().toISOString();
                    const productsRef = ref(database, `stores/0970528823/products`);
                    await push(productsRef, productData);
                    showMessage('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
                
                // Reset form and editing state
                addProductForm.classList.add('hidden');
                productForm.reset();
                resetProductForm();
                
            } catch (error) {
                const errorMessage = isEditingProduct ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                showMessage(errorMessage, 'error');
            }
        });

        function setupRealtimeListeners() {
            // Listen for products changes - use admin's products for all users
            const productsRef = ref(database, `stores/0970528823/products`);
            onValue(productsRef, (snapshot) => {
                products = snapshot.val() || {};
                displayProducts();
                displaySaleProducts();
            });

            // Listen for sales changes - use current user's sales
            const salesRef = ref(database, `stores/${currentUser.phone}/sales`);
            onValue(salesRef, (snapshot) => {
                sales = snapshot.val() || {};
                loadReports();
            });
        }

        function loadProducts() {
            // Load admin's products for all users to see
            const productsRef = ref(database, `stores/0970528823/products`);
            onValue(productsRef, (snapshot) => {
                products = snapshot.val() || {};
                displayProducts();
            });
        }

        function displayProducts() {
            const productsContainer = document.getElementById('productsContainer');
            productsContainer.innerHTML = '';

            if (Object.keys(products).length === 0) {
                productsContainer.innerHTML = '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>';
                return;
            }

            // Group products by category
            const categories = ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏Ç‡∏ô‡∏°', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
            const categoryIcons = {
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': 'ü•§',
                '‡∏Ç‡∏ô‡∏°': 'üç™',
                '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á': 'üçú',
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á': 'üßÇ',
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'üì¶'
            };

            categories.forEach(category => {
                const categoryProducts = Object.entries(products).filter(([id, product]) => 
                    product.category === category && (currentCategoryFilter === 'all' || currentCategoryFilter === category)
                );

                if (categoryProducts.length > 0 || currentCategoryFilter === category || currentCategoryFilter === 'all') {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'bg-white rounded-lg shadow mb-6';
                    
                    let categoryHTML = `
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                            <h3 class="text-lg font-medium text-gray-900">${categoryIcons[category]} ${category}</h3>
                        </div>
                        <div class="divide-y divide-gray-200">
                    `;

                    if (categoryProducts.length === 0) {
                        categoryHTML += '<div class="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</div>';
                    } else {
                        categoryProducts.forEach(([id, product]) => {
                            const canEdit = currentUser.role === 'admin';
                            categoryHTML += `
                                <div class="p-4 hover:bg-gray-50">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <h4 class="font-medium text-gray-900">${product.name}</h4>
                                            <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤: ${product.price} ‡∏ö‡∏≤‡∏ó | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                                            ${product.stock <= 5 ? '<p class="text-sm text-red-600">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</p>' : ''}
                                        </div>
                                        ${canEdit ? `
                                        <div class="flex space-x-2">
                                            <button onclick="editProduct('${id}')" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded border border-blue-600 hover:bg-blue-50">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onclick="deleteProduct('${id}')" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded border border-red-600 hover:bg-red-50">‡∏•‡∏ö</button>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    categoryHTML += '</div>';
                    categorySection.innerHTML = categoryHTML;
                    productsContainer.appendChild(categorySection);
                }
            });

            // Add category filter event listeners
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update active filter
                    document.querySelectorAll('.category-filter').forEach(b => {
                        b.classList.remove('active', 'bg-blue-600', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    e.target.classList.add('active', 'bg-blue-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'text-gray-700');
                    
                    currentCategoryFilter = e.target.dataset.category;
                    displayProducts();
                });
            });
        }

        function loadSaleProducts() {
            displaySalesContent();
        }

        function displaySalesContent() {
            const salesContent = document.getElementById('salesContent');
            
            if (currentUser.role === 'admin') {
                // Admin sees recent sales from all members
                displayAdminSalesView();
            } else {
                // Regular users see shopping interface
                displayShoppingInterface();
            }
        }

        function displayAdminSalesView() {
            const salesContent = document.getElementById('salesContent');
            salesContent.innerHTML = `
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    </div>
                    <div id="allMembersSales" class="divide-y divide-gray-200">
                        <!-- All members sales will be loaded here -->
                    </div>
                </div>
            `;
            loadAllMembersSales();
        }

        function displayShoppingInterface() {
            const salesContent = document.getElementById('salesContent');
            salesContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Product Selection -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <div id="saleProductsList" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Sale products will be loaded here -->
                        </div>
                    </div>

                    <!-- Cart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <div id="cart" class="space-y-2 mb-4">
                            <!-- Cart items will be shown here -->
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center text-lg font-semibold mb-4">
                                <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                <span id="totalAmount">0 ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            
                            <!-- Discount Section -->
                            <div id="discountSection" class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-yellow-800">üéâ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©!</span>
                                    <span id="discountAmount" class="text-sm font-bold text-yellow-800"></span>
                                </div>
                                <p id="discountText" class="text-xs text-yellow-700 mt-1"></p>
                            </div>

                            <!-- Payment Section -->
                            <div id="paymentSection" class="space-y-3">
                                <button id="checkoutBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            displaySaleProducts();
        }

        function displaySaleProducts() {
            const saleProductsList = document.getElementById('saleProductsList');
            if (!saleProductsList) return;
            
            saleProductsList.innerHTML = '';

            const allProducts = Object.entries(products);

            if (allProducts.length === 0) {
                saleProductsList.innerHTML = '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                return;
            }

            allProducts.forEach(([id, product]) => {
                const isOutOfStock = product.stock <= 0;
                const cartItem = cart.find(item => item.id === id);
                const cartQuantity = cartItem ? cartItem.quantity : 0;
                const availableStock = product.stock - cartQuantity;
                
                const productElement = document.createElement('div');
                productElement.className = `border rounded-lg p-4 ${isOutOfStock ? 'bg-gray-100 opacity-60' : 'hover:bg-gray-50'}`;
                productElement.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="font-medium ${isOutOfStock ? 'text-gray-500' : 'text-gray-900'}">${product.name}</h4>
                            <p class="text-sm text-gray-600">${product.price} ‡∏ö‡∏≤‡∏ó | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                            ${cartQuantity > 0 ? `<p class="text-xs text-blue-600">‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤: ${cartQuantity} ‡∏ä‡∏¥‡πâ‡∏ô</p>` : ''}
                            ${isOutOfStock ? '<p class="text-xs text-red-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</p>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                            <input type="number" id="qty_${id}" min="1" max="${Math.max(1, availableStock)}" value="1" 
                                   class="w-16 px-2 py-1 border border-gray-300 rounded text-center text-sm focus:ring-2 focus:ring-blue-500 ${isOutOfStock ? 'bg-gray-200' : ''}"
                                   ${isOutOfStock ? 'disabled' : ''}>
                        </div>
                        <button onclick="addToCartWithQuantity('${id}')" 
                                class="px-4 py-2 rounded text-sm font-medium transition duration-200 ${
                                    isOutOfStock 
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                }"
                                ${isOutOfStock ? 'disabled' : ''}>
                            ${isOutOfStock ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤'}
                        </button>
                    </div>
                `;
                saleProductsList.appendChild(productElement);
            });
        }

        async function loadAllMembersSales() {
            const allMembersSalesElement = document.getElementById('allMembersSales');
            if (!allMembersSalesElement) return;
            
            try {
                const usersRef = ref(database, 'users');
                const usersSnapshot = await get(usersRef);
                const users = usersSnapshot.val() || {};
                
                const allSales = [];
                
                // Get sales from all users
                for (const [phone, userData] of Object.entries(users)) {
                    if (phone !== '0970528823') { // Skip admin
                        const salesRef = ref(database, `stores/${phone}/sales`);
                        const salesSnapshot = await get(salesRef);
                        const userSales = salesSnapshot.val() || {};
                        
                        Object.entries(userSales).forEach(([saleId, sale]) => {
                            allSales.push({
                                ...sale,
                                saleId: saleId,
                                memberName: userData.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
                                memberPhone: phone
                            });
                        });
                    }
                }
                
                // Sort by timestamp (newest first)
                allSales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (allSales.length === 0) {
                    allMembersSalesElement.innerHTML = '<div class="p-6 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>';
                    return;
                }
                
                allMembersSalesElement.innerHTML = '';
                allSales.slice(0, 20).forEach((sale, index) => { // Show latest 20 sales
                    const saleElement = document.createElement('div');
                    saleElement.className = 'p-4 hover:bg-gray-50';
                    saleElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <p class="font-medium text-blue-600">${sale.memberName}</p>
                                    <span class="text-sm text-gray-500">(${sale.memberPhone})</span>
                                </div>
                                <p class="font-medium text-green-600">${sale.total} ‡∏ö‡∏≤‡∏ó</p>
                                <p class="text-sm text-gray-600">${new Date(sale.timestamp).toLocaleString('th-TH')}</p>
                                <div class="text-sm text-gray-500 mt-1">
                                    ${sale.items.map(item => `${item.name} x${item.quantity}`).join(', ')}
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="editSale('${sale.saleId}', '${sale.memberPhone}')" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded border border-blue-600 hover:bg-blue-50">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="deleteSale('${sale.saleId}', '${sale.memberPhone}')" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded border border-red-600 hover:bg-red-50">‡∏•‡∏ö</button>
                            </div>
                        </div>
                    `;
                    allMembersSalesElement.appendChild(saleElement);
                });
                
            } catch (error) {
                console.error('Error loading all members sales:', error);
                allMembersSalesElement.innerHTML = '<div class="p-6 text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }

        // Cart functionality
        window.addToCart = function(productId) {
            const product = products[productId];
            if (!product || product.stock <= 0) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                }
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            displayCart();
        };

        window.addToCartWithQuantity = function(productId) {
            const product = products[productId];
            if (!product) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            if (product.stock <= 0) {
                showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î', 'error');
                return;
            }

            const quantityInput = document.getElementById(`qty_${productId}`);
            const quantity = Math.max(1, parseInt(quantityInput.value) || 1);
            
            // Check current cart quantity for this product
            const existingItem = cart.find(item => item.id === productId);
            const currentCartQuantity = existingItem ? existingItem.quantity : 0;
            const availableStock = product.stock - currentCartQuantity;
            
            if (availableStock <= 0) {
                showToast(`‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô)`, 'error');
                quantityInput.value = 1;
                return;
            }
            
            // Limit quantity to available stock
            const actualQuantity = Math.min(quantity, availableStock);
            
            if (actualQuantity < quantity) {
                showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${actualQuantity} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${availableStock} ‡∏ä‡∏¥‡πâ‡∏ô)`, 'error');
            }

            if (existingItem) {
                existingItem.quantity += actualQuantity;
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: actualQuantity
                });
            }
            
            // Reset quantity input
            quantityInput.value = 1;
            displayCart();
            showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${product.name} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${actualQuantity} ‡∏ä‡∏¥‡πâ‡∏ô ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        };

        function displayCart() {
            const cartElement = document.getElementById('cart');
            const totalAmountElement = document.getElementById('totalAmount');
            
            if (!cartElement || !totalAmountElement) return;
            
            cartElement.innerHTML = '';
            let subtotal = 0;

            if (cart.length === 0) {
                cartElement.innerHTML = '<div class="text-center text-gray-500 py-4">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á</div>';
                totalAmountElement.textContent = '0 ‡∏ö‡∏≤‡∏ó';
                hideDiscount();
                return;
            }

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                const cartItem = document.createElement('div');
                cartItem.className = 'flex justify-between items-center p-2 border rounded';
                cartItem.innerHTML = `
                    <div class="flex-1">
                        <h5 class="font-medium">${item.name}</h5>
                        <p class="text-sm text-gray-600">${item.price} ‡∏ö‡∏≤‡∏ó x ${item.quantity} = ${itemTotal} ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateCartQuantity(${index}, ${item.quantity - 1})" class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-sm">-</button>
                        <span class="px-2">${item.quantity}</span>
                        <button onclick="updateCartQuantity(${index}, ${item.quantity + 1})" class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-sm">+</button>
                        <button onclick="removeFromCart(${index})" class="text-red-600 hover:text-red-800 text-sm ml-2">‡∏•‡∏ö</button>
                    </div>
                `;
                cartElement.appendChild(cartItem);
            });

            // Calculate discount
            const discount = calculateDiscount(subtotal);
            const total = subtotal - discount.amount;

            if (discount.amount > 0) {
                showDiscount(discount);
            } else {
                hideDiscount();
            }

            totalAmountElement.textContent = `${total} ‡∏ö‡∏≤‡∏ó`;
            
            // Enable/disable checkout button based on cart
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) {
                checkoutBtn.disabled = cart.length === 0;
                if (cart.length === 0) {
                    checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function calculateDiscount(subtotal) {
            let discount = { amount: 0, text: '', percentage: 0 };
            
            if (subtotal >= 1000) {
                discount.percentage = 10;
                discount.amount = subtotal * 0.1;
                discount.text = '‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö 1,000 ‡∏ö‡∏≤‡∏ó ‡∏•‡∏î 10%';
            } else if (subtotal >= 500) {
                discount.percentage = 5;
                discount.amount = subtotal * 0.05;
                discount.text = '‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö 500 ‡∏ö‡∏≤‡∏ó ‡∏•‡∏î 5%';
            } else if (subtotal >= 200) {
                discount.amount = 20;
                discount.text = '‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏ö 200 ‡∏ö‡∏≤‡∏ó ‡∏•‡∏î 20 ‡∏ö‡∏≤‡∏ó';
            }
            
            return discount;
        }

        function showDiscount(discount) {
            const discountSection = document.getElementById('discountSection');
            const discountAmount = document.getElementById('discountAmount');
            const discountText = document.getElementById('discountText');
            
            if (discountSection && discountAmount && discountText) {
                discountSection.classList.remove('hidden');
                discountAmount.textContent = `-${discount.amount} ‡∏ö‡∏≤‡∏ó`;
                discountText.textContent = discount.text;
            }
        }

        function hideDiscount() {
            const discountSection = document.getElementById('discountSection');
            if (discountSection) {
                discountSection.classList.add('hidden');
            }
        }

        window.updateCartQuantity = function(index, newQuantity) {
            if (newQuantity <= 0) {
                cart.splice(index, 1);
            } else {
                const product = products[cart[index].id];
                if (newQuantity <= product.stock) {
                    cart[index].quantity = newQuantity;
                } else {
                    showToast(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô`, 'error');
                    cart[index].quantity = product.stock;
                }
            }
            displayCart();
        };

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            displayCart();
        };

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            toast.style.transform = 'translateX(100%)';
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Receipt functions
        function showReceipt(saleData) {
            const receiptModal = document.getElementById('receiptModal');
            const receiptContent = document.getElementById('receiptContent');
            
            const receiptNumber = 'R' + Date.now().toString().slice(-6);
            const currentDate = new Date().toLocaleString('th-TH');
            
            receiptContent.innerHTML = `
                <div class="text-center border-b pb-4 mb-4">
                    <div class="text-xs text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${receiptNumber}</div>
                    <div class="text-xs text-gray-500">${currentDate}</div>
                    <div class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ${saleData.cashier}</div>
                    <div class="text-xs text-gray-500">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${getPaymentMethodText(saleData.paymentMethod)}</div>
                </div>
                
                <div class="space-y-2 mb-4">
                    ${saleData.items.map(item => `
                        <div class="flex justify-between text-sm">
                            <div class="flex-1">
                                <div>${item.name}</div>
                                <div class="text-xs text-gray-500">${item.price} x ${item.quantity}</div>
                            </div>
                            <div class="font-medium">${item.price * item.quantity} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                        <span>${saleData.subtotal} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    ${saleData.discount > 0 ? `
                        <div class="flex justify-between text-sm text-green-600">
                            <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                            <span>-${saleData.discount} ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                    ` : ''}
                    <div class="flex justify-between font-bold text-lg border-t pt-2">
                        <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                        <span>${saleData.total} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>
                
                <div class="text-center text-xs text-gray-500 mt-4 pt-4 border-t">
                    ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£<br>
                    ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô
                </div>
            `;
            
            receiptModal.classList.remove('hidden');
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cash': 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                'qr': 'üì± QR Code'
            };
            return methods[method] || 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
        }

        // Receipt modal event listeners
        document.getElementById('closeReceiptBtn').addEventListener('click', () => {
            document.getElementById('receiptModal').classList.add('hidden');
        });

        // QR Code Modal functions
        function showQrModal(amount) {
            const qrModal = document.getElementById('qrModal');
            const qrAmount = document.getElementById('qrAmount');
            qrAmount.textContent = `${amount} ‡∏ö‡∏≤‡∏ó`;
            qrModal.classList.remove('hidden');
        }

        function hideQrModal() {
            const qrModal = document.getElementById('qrModal');
            qrModal.classList.add('hidden');
        }

        // QR Code Modal event listeners
        document.getElementById('cancelQrPaymentBtn').addEventListener('click', () => {
            hideQrModal();
        });

        document.getElementById('confirmQrPaymentBtn').addEventListener('click', async () => {
            hideQrModal();
            await processCheckout('qr');
        });

        // Process checkout function
        async function processCheckout(paymentMethod) {
            if (cart.length === 0) {
                showToast('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }

            // Disable checkout button to prevent double submission
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) {
                checkoutBtn.disabled = true;
                checkoutBtn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            }

            try {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const discount = calculateDiscount(subtotal);
                const total = subtotal - discount.amount;

                const saleData = {
                    items: [...cart], // Create a copy of cart
                    subtotal: subtotal,
                    discount: discount.amount,
                    discountText: discount.text,
                    total: total,
                    paymentMethod: paymentMethod,
                    timestamp: new Date().toISOString(),
                    date: new Date().toDateString(),
                    cashier: currentUser.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
                };

                // If Firebase is available, try to save data
                if (isFirebaseReady && database) {
                    try {
                        // Check stock availability before processing
                        for (const item of cart) {
                            const product = products[item.id];
                            if (!product) {
                                throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}"`);
                            }
                            if (product.stock < item.quantity) {
                                throw new Error(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${item.name}" ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô`);
                            }
                        }

                        // Save sale to user's store
                        const salesRef = ref(database, `stores/${currentUser.phone}/sales`);
                        await push(salesRef, saleData);

                        // Update product stock in admin's store
                        const stockUpdates = {};
                        for (const item of cart) {
                            const product = products[item.id];
                            const newStock = Math.max(0, product.stock - item.quantity);
                            stockUpdates[`stores/0970528823/products/${item.id}/stock`] = newStock;
                            stockUpdates[`stores/0970528823/products/${item.id}/updatedAt`] = new Date().toISOString();
                        }

                        // Apply all stock updates atomically
                        await update(ref(database), stockUpdates);
                    } catch (dbError) {
                        console.warn('Database error, proceeding with local processing:', dbError);
                        // Continue with local processing even if database fails
                    }
                }

                // Show receipt
                showReceipt(saleData);

                // Clear cart
                cart = [];
                displayCart();
                
                // Show success message
                showToast(`üéâ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total} ‡∏ö‡∏≤‡∏ó`, 'success');
                
                // Also show a more prominent success notification
                setTimeout(() => {
                    showToast(`‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£!`, 'success');
                }, 1500);
                
            } catch (error) {
                console.error('Checkout error:', error);
                
                // Even if there's an error, still show success for demo purposes
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const discount = calculateDiscount(subtotal);
                const total = subtotal - discount.amount;
                
                const saleData = {
                    items: [...cart],
                    subtotal: subtotal,
                    discount: discount.amount,
                    discountText: discount.text,
                    total: total,
                    paymentMethod: paymentMethod,
                    timestamp: new Date().toISOString(),
                    date: new Date().toDateString(),
                    cashier: currentUser.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
                };
                
                // Show receipt even on error
                showReceipt(saleData);
                
                // Clear cart
                cart = [];
                displayCart();
                
                // Show success message
                showToast(`üéâ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${total} ‡∏ö‡∏≤‡∏ó`, 'success');
                
            } finally {
                // Re-enable checkout button
                if (checkoutBtn) {
                    checkoutBtn.disabled = false;
                    checkoutBtn.innerHTML = '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
                }
            }
        }

        // Checkout functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Use event delegation for dynamically created checkout button
            document.addEventListener('click', async function(e) {
                if (e.target && e.target.id === 'checkoutBtn') {
                    e.preventDefault();
                    
                    if (cart.length === 0) {
                        showToast('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                        return;
                    }

                    // Process payment directly (default to cash)
                    await processCheckout('cash');
                }
            });
        });

        // Sales management functions for admin
        window.editSale = async function(saleId, memberPhone) {
            if (currentUser.role !== 'admin') {
                showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
                return;
            }

            try {
                const saleRef = ref(database, `stores/${memberPhone}/sales/${saleId}`);
                const snapshot = await get(saleRef);
                
                if (snapshot.exists()) {
                    const saleData = snapshot.val();
                    
                    // Create custom modal for editing
                    const editModal = document.createElement('div');
                    editModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                    editModal.innerHTML = `
                        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-2xl max-h-full overflow-y-auto">
                            <div class="text-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>
                                <p class="text-gray-600">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${saleData.cashier}</p>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                    <div id="editItemsList" class="space-y-3 max-h-60 overflow-y-auto border rounded-lg p-4">
                                        <!-- Items will be populated here -->
                                    </div>
                                    <button id="addNewItemBtn" class="mt-3 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm">
                                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                                    </button>
                                </div>

                                <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢:</span>
                                        <span id="editSubtotal" class="font-medium">0 ‡∏ö‡∏≤‡∏ó</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                                        <input type="number" id="editDiscount" step="0.01" min="0" 
                                               class="w-24 px-2 py-1 border border-gray-300 rounded text-right text-sm"
                                               value="${saleData.discount || 0}">
                                        <span class="text-sm text-gray-600 ml-1">‡∏ö‡∏≤‡∏ó</span>
                                    </div>
                                    <div class="flex justify-between items-center text-lg font-bold border-t pt-2">
                                        <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                                        <span id="editFinalTotal" class="text-green-600">0 ‡∏ö‡∏≤‡∏ó</span>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-3 pt-4">
                                    <button id="confirmEditSale" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    </button>
                                    <button id="cancelEditSale" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(editModal);
                    
                    // Initialize edit items
                    let editItems = [...saleData.items];
                    
                    function renderEditItems() {
                        const itemsList = document.getElementById('editItemsList');
                        itemsList.innerHTML = '';
                        
                        if (editItems.length === 0) {
                            itemsList.innerHTML = '<div class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                        } else {
                            editItems.forEach((item, index) => {
                                const itemElement = document.createElement('div');
                                itemElement.className = 'flex items-center space-x-3 p-3 border rounded-lg bg-white';
                                itemElement.innerHTML = `
                                    <div class="flex-1">
                                        <input type="text" value="${item.name}" 
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium"
                                               onchange="updateItemName(${index}, this.value)">
                                    </div>
                                    <div class="w-20">
                                        <input type="number" value="${item.price}" step="0.01" min="0"
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center"
                                               onchange="updateItemPrice(${index}, this.value)"
                                               placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
                                    </div>
                                    <div class="w-16">
                                        <input type="number" value="${item.quantity}" min="1"
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-center"
                                               onchange="updateItemQuantity(${index}, this.value)"
                                               placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
                                    </div>
                                    <div class="w-20 text-sm font-medium text-right">
                                        ${(item.price * item.quantity).toFixed(2)} ‡∏ö‡∏≤‡∏ó
                                    </div>
                                    <button onclick="removeEditItem(${index})" 
                                            class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded border border-red-600 hover:bg-red-50">
                                        ‡∏•‡∏ö
                                    </button>
                                `;
                                itemsList.appendChild(itemElement);
                            });
                        }
                        
                        updateEditTotals();
                    }
                    
                    function updateEditTotals() {
                        const subtotal = editItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        const discount = parseFloat(document.getElementById('editDiscount').value) || 0;
                        const finalTotal = Math.max(0, subtotal - discount);
                        
                        document.getElementById('editSubtotal').textContent = `${subtotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
                        document.getElementById('editFinalTotal').textContent = `${finalTotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
                    }
                    
                    // Global functions for item editing
                    window.updateItemName = function(index, name) {
                        editItems[index].name = name;
                        renderEditItems();
                    };
                    
                    window.updateItemPrice = function(index, price) {
                        editItems[index].price = parseFloat(price) || 0;
                        renderEditItems();
                    };
                    
                    window.updateItemQuantity = function(index, quantity) {
                        editItems[index].quantity = parseInt(quantity) || 1;
                        renderEditItems();
                    };
                    
                    window.removeEditItem = function(index) {
                        editItems.splice(index, 1);
                        renderEditItems();
                    };
                    
                    // Add new item functionality
                    document.getElementById('addNewItemBtn').addEventListener('click', () => {
                        // Create modal for selecting product
                        const selectModal = document.createElement('div');
                        selectModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                        selectModal.innerHTML = `
                            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
                                <div class="text-center mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                        <select id="productSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                                            ${Object.entries(products).map(([id, product]) => 
                                                `<option value="${id}">${product.name} - ${product.price} ‡∏ö‡∏≤‡∏ó</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    

                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                                        <input type="number" id="productQuantity" min="1" value="1"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                
                                <div class="flex space-x-3 mt-6">
                                    <button id="confirmAddProduct" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                    </button>
                                    <button id="cancelAddProduct" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(selectModal);
                        

                        
                        // Handle confirm add
                        document.getElementById('confirmAddProduct').addEventListener('click', () => {
                            const selectedValue = document.getElementById('productSelect').value;
                            const quantity = parseInt(document.getElementById('productQuantity').value) || 1;
                            
                            if (!selectedValue) {
                                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                                return;
                            }
                            
                            const product = products[selectedValue];
                            if (!product) {
                                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
                                return;
                            }
                            
                            const newItem = {
                                name: product.name,
                                price: product.price,
                                quantity: quantity
                            };
                            
                            editItems.push(newItem);
                            renderEditItems();
                            document.body.removeChild(selectModal);
                        });
                        
                        // Handle cancel
                        document.getElementById('cancelAddProduct').addEventListener('click', () => {
                            document.body.removeChild(selectModal);
                        });
                        
                        // Close on backdrop click
                        selectModal.addEventListener('click', (e) => {
                            if (e.target === selectModal) {
                                document.body.removeChild(selectModal);
                            }
                        });
                    });
                    
                    // Update totals when discount changes
                    document.getElementById('editDiscount').addEventListener('input', updateEditTotals);
                    
                    // Initial render
                    renderEditItems();
                    
                    // Handle confirm edit
                    document.getElementById('confirmEditSale').addEventListener('click', async () => {
                        if (editItems.length === 0) {
                            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                            return;
                        }
                        
                        // Validate items
                        for (let item of editItems) {
                            if (!item.name.trim()) {
                                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                                return;
                            }
                            if (item.price <= 0) {
                                showToast('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
                                return;
                            }
                            if (item.quantity <= 0) {
                                showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0', 'error');
                                return;
                            }
                        }
                        
                        const subtotal = editItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        const discount = parseFloat(document.getElementById('editDiscount').value) || 0;
                        const finalTotal = Math.max(0, subtotal - discount);
                        
                        try {
                            await update(saleRef, {
                                items: editItems,
                                subtotal: subtotal,
                                discount: discount,
                                total: finalTotal,
                                updatedAt: new Date().toISOString(),
                                updatedBy: 'admin'
                            });
                            
                            document.body.removeChild(editModal);
                            showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                            loadAllMembersSales();
                            loadReports();
                            
                            // Clean up global functions
                            delete window.updateItemName;
                            delete window.updateItemPrice;
                            delete window.updateItemQuantity;
                            delete window.removeEditItem;
                        } catch (error) {
                            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                        }
                    });
                    
                    // Handle cancel
                    document.getElementById('cancelEditSale').addEventListener('click', () => {
                        document.body.removeChild(editModal);
                        // Clean up global functions
                        delete window.updateItemName;
                        delete window.updateItemPrice;
                        delete window.updateItemQuantity;
                        delete window.removeEditItem;
                    });
                    
                    // Close on backdrop click
                    editModal.addEventListener('click', (e) => {
                        if (e.target === editModal) {
                            document.body.removeChild(editModal);
                            // Clean up global functions
                            delete window.updateItemName;
                            delete window.updateItemPrice;
                            delete window.updateItemQuantity;
                            delete window.removeEditItem;
                        }
                    });
                }
            } catch (error) {
                console.error('Error editing sale:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', 'error');
            }
        };

        window.deleteSale = async function(saleId, memberPhone) {
            if (currentUser.role !== 'admin') {
                showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
                return;
            }

            try {
                const saleRef = ref(database, `stores/${memberPhone}/sales/${saleId}`);
                const snapshot = await get(saleRef);
                
                if (snapshot.exists()) {
                    const saleData = snapshot.val();
                    
                    // Create custom confirmation modal
                    const deleteModal = document.createElement('div');
                    deleteModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                    deleteModal.innerHTML = `
                        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
                                <p class="text-gray-600">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <div class="text-sm text-gray-600">
                                    <strong>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</strong> ${saleData.cashier}<br>
                                    <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${saleData.total} ‡∏ö‡∏≤‡∏ó<br>
                                    <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(saleData.timestamp).toLocaleString('th-TH')}<br>
                                    <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> ${saleData.items.map(item => `${item.name} x${item.quantity}`).join(', ')}
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button id="confirmDeleteSale" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition duration-200 font-medium">
                                    ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö
                                </button>
                                <button id="cancelDeleteSale" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(deleteModal);
                    
                    // Handle confirm delete
                    document.getElementById('confirmDeleteSale').addEventListener('click', async () => {
                        try {
                            await remove(saleRef);
                            document.body.removeChild(deleteModal);
                            showToast('‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                            loadAllMembersSales();
                            loadReports();
                        } catch (error) {
                            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                        }
                    });
                    
                    // Handle cancel
                    document.getElementById('cancelDeleteSale').addEventListener('click', () => {
                        document.body.removeChild(deleteModal);
                    });
                    
                    // Close on backdrop click
                    deleteModal.addEventListener('click', (e) => {
                        if (e.target === deleteModal) {
                            document.body.removeChild(deleteModal);
                        }
                    });
                }
            } catch (error) {
                console.error('Error deleting sale:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢', 'error');
            }
        };

        // Product management functions
        let isEditingProduct = false;
        let editingProductId = null;

        window.editProduct = async function(productId) {
            const product = products[productId];
            if (!product) return;

            // Set editing mode
            isEditingProduct = true;
            editingProductId = productId;

            // Fill form with existing data
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productCategory').value = product.category;

            // Change button text to indicate editing
            const submitButton = productForm.querySelector('button[type="submit"]');
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            submitButton.className = 'bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition duration-200 mr-2';

            // Show form title for editing
            const formTitle = document.querySelector('#addProductForm h3');
            formTitle.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${product.name}`;

            addProductForm.classList.remove('hidden');
            addProductForm.classList.add('fade-in');
        };

        window.deleteProduct = async function(productId) {
            if (currentUser.role !== 'admin') {
                showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ', 'error');
                return;
            }

            const product = products[productId];
            if (!product) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }

            // Create custom confirmation modal
            const deleteModal = document.createElement('div');
            deleteModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            deleteModal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                        <p class="text-gray-600">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="text-sm text-gray-600">
                            <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> ${product.name}<br>
                            <strong>‡∏£‡∏≤‡∏Ñ‡∏≤:</strong> ${product.price} ‡∏ö‡∏≤‡∏ó<br>
                            <strong>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô<br>
                            <strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</strong> ${product.category}
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 p-3 rounded-lg mb-6">
                        <p class="text-red-700 text-sm">
                            <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button id="confirmDeleteProduct" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition duration-200 font-medium">
                            ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö
                        </button>
                        <button id="cancelDeleteProduct" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deleteModal);
            
            // Handle confirm delete
            document.getElementById('confirmDeleteProduct').addEventListener('click', async () => {
                try {
                    // Show loading state
                    const confirmBtn = document.getElementById('confirmDeleteProduct');
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<div class="loading"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
                    
                    // Delete from admin's store
                    const productRef = ref(database, `stores/0970528823/products/${productId}`);
                    await remove(productRef);
                    
                    document.body.removeChild(deleteModal);
                    showToast(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${product.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
                    
                    // If currently editing this product, reset form
                    if (isEditingProduct && editingProductId === productId) {
                        addProductForm.classList.add('hidden');
                        productForm.reset();
                        resetProductForm();
                    }
                    
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                    
                    // Reset button state
                    const confirmBtn = document.getElementById('confirmDeleteProduct');
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö';
                }
            });
            
            // Handle cancel
            document.getElementById('cancelDeleteProduct').addEventListener('click', () => {
                document.body.removeChild(deleteModal);
            });
            
            // Close on backdrop click
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) {
                    document.body.removeChild(deleteModal);
                }
            });
        };

        // Purchase History functionality
        function loadPurchaseHistory() {
            const purchaseHistoryElement = document.getElementById('purchaseHistory');
            if (!purchaseHistoryElement) return;
            
            const userSales = Object.values(sales).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (userSales.length === 0) {
                purchaseHistoryElement.innerHTML = '<div class="p-6 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                return;
            }
            
            purchaseHistoryElement.innerHTML = '';
            userSales.forEach(sale => {
                const saleElement = document.createElement('div');
                saleElement.className = 'p-4 hover:bg-gray-50';
                saleElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-medium text-green-600">${sale.total} ‡∏ö‡∏≤‡∏ó</span>
                                <span class="text-xs px-2 py-1 rounded-full ${sale.paymentMethod === 'cash' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${getPaymentMethodText(sale.paymentMethod)}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">${new Date(sale.timestamp).toLocaleString('th-TH')}</p>
                            <div class="text-sm text-gray-500 mt-2">
                                <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</strong><br>
                                ${sale.items.map(item => `‚Ä¢ ${item.name} x${item.quantity} = ${item.price * item.quantity} ‡∏ö‡∏≤‡∏ó`).join('<br>')}
                            </div>
                            ${sale.discount > 0 ? `
                                <div class="text-sm text-green-600 mt-1">
                                    üí∞ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${sale.discount} ‡∏ö‡∏≤‡∏ó (${sale.discountText})
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                purchaseHistoryElement.appendChild(saleElement);
            });
        }

        // Reports functionality
        function loadReports() {
            if (currentUser.role === 'admin') {
                loadAdminReports();
            } else {
                loadUserReports();
            }
        }

        async function loadAdminReports() {
            try {
                // Get all users
                const usersRef = ref(database, 'users');
                const usersSnapshot = await get(usersRef);
                const users = usersSnapshot.val() || {};
                
                let totalItemsSold = 0;
                let totalOrders = 0;
                
                // Calculate total items sold from all members
                for (const [phone, userData] of Object.entries(users)) {
                    if (phone !== '0970528823') { // Skip admin
                        const salesRef = ref(database, `stores/${phone}/sales`);
                        const salesSnapshot = await get(salesRef);
                        const userSales = salesSnapshot.val() || {};
                        
                        Object.values(userSales).forEach(sale => {
                            totalOrders++;
                            sale.items.forEach(item => {
                                totalItemsSold += item.quantity;
                            });
                        });
                    }
                }
                
                // Calculate total stock remaining
                let totalStockRemaining = 0;
                Object.values(products).forEach(product => {
                    totalStockRemaining += product.stock;
                });
                
                // Update dashboard
                document.getElementById('todaySales').textContent = `${totalItemsSold} ‡∏ä‡∏¥‡πâ‡∏ô`;
                document.getElementById('totalProducts').textContent = `${totalStockRemaining} ‡∏ä‡∏¥‡πâ‡∏ô`;
                document.getElementById('todayOrders').textContent = totalOrders;
                
            } catch (error) {
                console.error('Error loading admin reports:', error);
                document.getElementById('todaySales').textContent = '0 ‡∏ä‡∏¥‡πâ‡∏ô';
                let totalStockRemaining = 0;
                Object.values(products).forEach(product => {
                    totalStockRemaining += product.stock;
                });
                document.getElementById('totalProducts').textContent = `${totalStockRemaining} ‡∏ä‡∏¥‡πâ‡∏ô`;
                document.getElementById('todayOrders').textContent = '0';
            }
        }

        async function loadUserReports() {
            try {
                // Get all users for total sold calculation
                const usersRef = ref(database, 'users');
                const usersSnapshot = await get(usersRef);
                const users = usersSnapshot.val() || {};
                
                let totalItemsSold = 0;
                let totalOrders = 0;
                
                // Calculate total items sold from all members (same as admin)
                for (const [phone, userData] of Object.entries(users)) {
                    if (phone !== '0970528823') { // Skip admin
                        const salesRef = ref(database, `stores/${phone}/sales`);
                        const salesSnapshot = await get(salesRef);
                        const userSales = salesSnapshot.val() || {};
                        
                        Object.values(userSales).forEach(sale => {
                            totalOrders++;
                            sale.items.forEach(item => {
                                totalItemsSold += item.quantity;
                            });
                        });
                    }
                }
                
                // Calculate total stock remaining
                let totalStockRemaining = 0;
                Object.values(products).forEach(product => {
                    totalStockRemaining += product.stock;
                });

                // Update dashboard for regular users (same as admin view)
                document.getElementById('todaySales').textContent = `${totalItemsSold} ‡∏ä‡∏¥‡πâ‡∏ô`;
                document.getElementById('totalProducts').textContent = `${totalStockRemaining} ‡∏ä‡∏¥‡πâ‡∏ô`;
                document.getElementById('todayOrders').textContent = totalOrders;
                
            } catch (error) {
                console.error('Error loading user reports:', error);
                document.getElementById('todaySales').textContent = '0 ‡∏ä‡∏¥‡πâ‡∏ô';
                let totalStockRemaining = 0;
                Object.values(products).forEach(product => {
                    totalStockRemaining += product.stock;
                });
                document.getElementById('totalProducts').textContent = `${totalStockRemaining} ‡∏ä‡∏¥‡πâ‡∏ô`;
                document.getElementById('todayOrders').textContent = '0';
            }
        }

        // Initialize admin account if not exists
        async function initializeAdmin() {
            try {
                const adminRef = ref(database, 'users/0970528823');
                const snapshot = await get(adminRef);
                
                if (!snapshot.exists()) {
                    const adminData = {
                        name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                        password: '123456',
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    };
                    await set(adminRef, adminData);
                    console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                }
            } catch (error) {
                console.error('Error initializing admin:', error);
            }
        }

        // Initialize app
        console.log('üè™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        
        // Initialize admin account
        if (isFirebaseReady) {
            initializeAdmin();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f4d53977d3a1ae',t:'MTc2MDU4OTE1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
    
</script></body>
</html>
